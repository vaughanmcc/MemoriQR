name: Preview Smoke Test

# ADDED: This block cancels older runs if a new deployment status is received
concurrency:
  group: ${{ github.workflow }}-${{ github.event.deployment_status.target_url }}
  cancel-in-progress: true

on:
  deployment_status:

jobs:
  smoke-test:
    if: github.event.deployment_status.state == 'success' && github.event.deployment_status.environment == 'Preview'
    runs-on: ubuntu-latest
    # REDUCED: Lowered from 5 to 3 minutes to save on potential hanging costs
    timeout-minutes: 3

    steps:
      - name: Get Preview URL
        id: preview
        run: |
          echo "url=${{ github.event.deployment_status.target_url }}" >> $GITHUB_OUTPUT

      # REDUCED: Lowered wait time from 10s to 5s for faster feedback
      - name: Wait for deployment to be ready
        run: sleep 5

      - name: Run Smoke Tests
        run: |
          URL="${{ steps.preview.outputs.url }}"
          
          # Function to check pages quickly
          check_page() {
            local path=$1
            echo "Testing $URL$path..."
            response=$(curl -s -o /dev/null -w "%{http_code}" "$URL$path")
            if [ "$response" != "200" ]; then
              echo "‚ùå $path returned $response"
              exit 1
            fi
            echo "‚úÖ $path OK (200)"
          }

          check_page ""
          check_page "/order"
          check_page "/activate"
          check_page "/about"
          check_page "/contact"
          
          # API Check
          echo "Testing API Health..."
          api_res=$(curl -s -o /dev/null -w "%{http_code}" "$URL/api/memorial/lookup?slug=test")
          if [ "$api_res" == "500" ]; then
            echo "‚ùå API returned 500 error"
            exit 1
          fi
          echo "‚úÖ API responding (returned $api_res)"

      - name: Summary
        run: echo "üéâ All smoke tests passed for ${{ steps.preview.outputs.url }}"
